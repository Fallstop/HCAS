"use strict";var clearHash=function clearHash(){return history.pushState("",document.title,window.location.pathname+window.location.search)};var $types=$("#types");var $pages=$("#pages");var $loader=$("#loader");var $loaderText=$("#loaderText");var $guestName=$("#guestName");var $memberName=$("#memberName");var $guestSubmit=$("#guestSubmit");var $memberSubmit=$("#memberSubmit");$(window).on("hashchange",function(){var hash=window.location.hash;var pages=["guest","member","facilitator"];if(hash.length<1){return}var page=hash.substr(1);if(!pages.includes(page)){return resetPage()}toPage(page)});function toPage(id){$(".member-types__type").prop("disabled",true);$types.addClass("member-types--hidden");$pages.removeClass("sign-pages--hidden");$('.sign-pages__page[page-id="'.concat(id,'"]')).removeClass("sign-pages__page--hidden")}function resetPage(){$(".member-types__type").prop("disabled",false);$types.removeClass("member-types--hidden");$pages.addClass("sign-pages--hidden");$(".sign-pages__page").addClass("sign-pages__page--hidden");clearHash();$guestName.val("");$memberName.val("");$(".members__list__item").prop("checked",false);selectedMember=null;$memberSubmit.prop("disabled",true);clearMembersList()}$("#signBack").on("click",function(){return resetPage()});var members=[];var selectedMember=null;function loadMembers(){showLoader("Loading Members...");var fail=function fail(point){return showToast("Failed to load members... POINT="+point,null,true)};$.get("/members").done(function(res){if(!res.hasOwnProperty("status")){fail(0)}else{if(res.status==="success"&&res.hasOwnProperty("members")){members=res.members}else{fail(1)}}}).fail(function(){return fail(2)}).always(function(){return hideLoader()})}function getRelevantMembers(name){if(name==null){return[]}name=name.toLowerCase();var matching=[];var rankings={};members.forEach(function(member){var lowerName=member.toLowerCase();var ranking=0;if(name===lowerName){ranking=4}else{if(lowerName.startsWith(name))ranking+=2;if(lowerName.indexOf(name)>=0)ranking+=1}rankings[member]=ranking;if(ranking>0){matching.push(member)}});matching.sort(function(a,b){return rankings[b]-rankings[a]});return matching}function clearMembersList(){var $membersList=$("#membersList");$membersList.children().remove()}function fillMembersList(){var name=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(name==null||name.length===0)name=null;var $membersList=$("#membersList");var members=getRelevantMembers(name);clearMembersList();members.forEach(function(member){var $item=$("<label/>",{class:"members__list__item",text:member});var $radio=$("<input/>",{type:"radio",name:"members",class:"members__list__item__button",value:member});$radio.on("click",function(){var $button=$(this);var $parent=$button.parent();var checked=$button.is(":checked");if(checked){if($parent.hasClass("members__list__item--selected")){$parent.removeClass("members__list__item--selected");selectedMember=null;$button.prop("checked",false)}else{$(".members__list__item").removeClass("members__list__item--selected");$parent.addClass("members__list__item--selected");selectedMember=$button.attr("value")}}$memberSubmit.prop("disabled",selectedMember==null)});$radio.appendTo($item);$item.appendTo($membersList)})}$memberName.on("input",function(){return fillMembersList($memberName.val())});function showLoader(){var text=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"Loading...";$loader.addClass("loader__wrapper--open");$loaderText.val(text)}function hideLoader(){$loader.removeClass("loader__wrapper--open")}var currentToastTimeout=-1;function showToast(text){var undoCallback=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var error=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var duration=arguments.length>3&&arguments[3]!==undefined?arguments[3]:2500;var $toast=$("#toast");var $toastText=$("#toastText");var $toastUndo=$("#toastUndo");if(error){$toast.addClass("toast--error")}else{$toast.removeClass("toast--error")}$toastUndo.bind("click",function(){return undoCallback!=null&&undoCallback()});if(undoCallback==null){$toastUndo.css("display","none")}else{$toastUndo.css("display","revert")}$toastText.text(text);$toast.removeClass("toast--hidden");if(currentToastTimeout!==-1){clearTimeout(currentToastTimeout)}currentToastTimeout=setTimeout(function(){$toast.addClass("toast--hidden");$toastUndo.unbind("click")},duration)}clearHash();if(document.location.pathname!=="/attending"){loadMembers()}$memberSubmit.on("click",function(){if(selectedMember==null)return;var name=selectedMember;saveAttendance(name,true,function(){showToast('Successfully marked attendance for "'+name+'"',function(){removeAttendance(name,function(){showToast('Reverted attendance for "'+name+'"')})});resetPage()})});$guestSubmit.on("click",function(){var name=$guestName.val();if(name!=null&&name.length>0){saveAttendance(name,false,function(){showToast('Successfully marked attendance for "'+name+'"',function(){removeAttendance(name,function(){showToast('Reverted attendance for "'+name+'"')})});resetPage()})}});function saveAttendance(name,member,callback){showLoader("Saving Attendance...");var fail=function fail(point){return showToast("Failed to mark attendance... POINT="+point,null,true)};$.post("/attendance",{name:name,member:member}).done(function(res){if(!res.hasOwnProperty("status")){fail(0)}else{if(res.status==="success"){callback()}else{if(res.hasOwnProperty("reason")){showToast(res.reason,null,true)}else fail(1)}}}).fail(function(){return fail(2)}).always(function(){return hideLoader()})}function removeAttendance(name,callback){showLoader("Removing Attendance...");var fail=function fail(point){return showToast("Failed to change attendance... POINT="+point,null,true)};$.ajax("/attendance",{type:"DELETE",data:{name:name}}).done(function(res){if(!res.hasOwnProperty("status")){fail(0)}else{if(res.status==="success"){showToast('Successfully removed attendance for "'+name+'"',null);callback()}else{fail(1)}}}).fail(function(){return fail(2)}).always(function(){return hideLoader()})}$(".attendance__list__item__buttons__button").on("click",function(){var $button=$(this);var name=$button.attr("data-name");if(name!==undefined&&name!==null){removeAttendance(name,function(){return $button.parents(".attendance__list__item").remove()})}});