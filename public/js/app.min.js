"use strict";var clearHash=function(){return history.pushState("",document.title,window.location.pathname+window.location.search)},$types=document.getElementById("types"),$pages=document.getElementById("pages"),$loader=document.getElementById("loader"),$guestName=document.getElementById("guestName"),$memberName=document.getElementById("memberName"),$guestSubmit=document.getElementById("guestSubmit"),$memberSubmit=document.getElementById("memberSubmit"),$membersList=document.getElementById("membersList");function elements(e,t){for(var n=0,s=document.querySelectorAll(e);n<s.length;n++)t(s[n])}function nonNull(e,t){null!=e&&t(e)}function triggerClick(e){var t=document.createEvent("MouseEvents");t.initEvent("click",!0,!0),e.dispatchEvent(t)}function isEnterKey(e){var t;return void 0!==e.key?t=e.key:void 0!==e.keyIdentifier?t=e.keyIdentifier:void 0!==e.keyCode&&(t=e.keyCode),"Enter"===t||"Return"===t||13===t}function removeChildren(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function showLoader(){$loader.classList.remove("loading-bar--hidden")}function hideLoader(){$loader.classList.add("loading-bar--hidden")}var toastHandle=-1,toastEventListener=null;function showToast(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=2<arguments.length&&void 0!==arguments[2]&&arguments[2],s=3<arguments.length&&void 0!==arguments[3]?arguments[3]:2500,r=document.getElementById("toast"),o=document.getElementById("toastText"),a=document.getElementById("toastUndo");n?r.classList.add("toast--error"):r.classList.remove("toast--error"),null!=toastEventListener&&a.removeEventListener("click",toastEventListener),toastEventListener=function(){return null!=t&&t()},a.addEventListener("click",toastEventListener),null==t?a.classList.add("toast__undo--hidden"):a.classList.remove("toast__undo--hidden"),o.textContent=e,r.classList.remove("toast--hidden"),-1!==toastHandle&&clearTimeout(toastHandle),toastHandle=setTimeout(function(){r.classList.add("toast--hidden"),null!=toastEventListener&&a.removeEventListener("click",toastEventListener)},s)}function request(e,t,n,s){var r=new XMLHttpRequest;r.open(e,t,!0);for(var o=Object.keys(n),a=0;a<o.length;a++){var i=o[a],l=n[i];r.setRequestHeader(i,l)}return r.onload=function(){var e;200<=this.status&&this.status<=400?(e=JSON.parse(this.response),s(null,e)):s("Connected to server but unable to process request.",null)},r.onerror=function(){s("Unable to connect to server",null)},r}function encodeForm(e){for(var t="",n=Object.keys(e),s=0;s<n.length;s++){var r=n[s],o=e[r];t+=encodeURIComponent(r)+"="+encodeURIComponent(o)+"&"}return t.substr(0,t.length-1)}function get(e,t){request("GET",e,{Accept:"application/json; charset=UTF-8"},t).send()}function post(e,t,n){request("POST",e,{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Accept:"application/json; charset=UTF-8"},n).send(encodeForm(t))}function del(e,t,n){request("DELETE",e,{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Accept:"application/json; charset=UTF-8"},n).send(encodeForm(t))}function toPage(e){resetTimeout(),elements(".member-types__type",function(e){return e.disabled=!0}),$types.classList.add("member-types--hidden"),$pages.classList.remove("sign-pages--hidden"),nonNull(document.querySelector('.sign-pages__page[page-id="'+e+'"]'),function(e){return e.classList.remove("sign-pages__page--hidden")}),("member"===e?$memberName:$guestName).focus()}function resetPage(){resetTimeout(),elements(".member-types__type",function(e){return e.disabled=!1}),$types.classList.remove("member-types--hidden"),$pages.classList.add("sign-pages--hidden"),elements(".sign-pages__page",function(e){return e.classList.add("sign-pages__page--hidden")}),clearHash(),$guestName.value="",$memberName.value="",elements(".members__list__item",function(e){return e.checked=!1}),selectedMember=null,$guestSubmit.disabled=!0,$memberSubmit.disabled=!0,removeChildren($membersList),$memberName.blur(),$guestName.blur()}function setCacheBadge(e){var t=document.getElementById("cacheIndicator");e?t.classList.remove("cache-indicator--hidden"):t.classList.add("cache-indicator--hidden")}window.onhashchange=function(){var e=window.location.hash;if(!(e.length<1)){e=e.substr(1);if(!["guest","member"].includes(e))return resetPage();toPage(e)}},nonNull(document.getElementById("signBack"),function(e){return e.onclick=function(){return resetPage()}});var members=[],selectedMember=null,LOAD_RETRY_DELAY=2e3;function loadMembers(){showLoader();function n(e){showToast("Failed to load members: ".concat(e," (Retrying in ").concat(LOAD_RETRY_DELAY/1e3,"s)"),null,!0),setTimeout(function(){loadMembers()},LOAD_RETRY_DELAY)}get("/members",function(e,t){null!=e?n(e):t.hasOwnProperty("status")?"success"===t.status&&t.hasOwnProperty("members")&&t.hasOwnProperty("cached")?(members=t.members,setCacheBadge(t.cached)):n("Malformed Server Response"):n("Malformed Server Response status missing"),hideLoader()})}function getRelevantMembers(e){if(null==e)return[];e=e.toLowerCase();for(var t=[],n={},s=0;s<members.length;s++){var r=members[s],o=r.toLowerCase(),a=0;e===o?a=4:(o.startsWith(e)&&(a+=2),0<=o.indexOf(e)&&(a+=1)),0<(n[r]=a)&&t.push(r)}return t.sort(function(e,t){return n[t]-n[e]}),t}function fillMembersList(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,s=getRelevantMembers(e=null==e||0===e.length?null:e);removeChildren($membersList);for(var r=5,t=0;t<s.length;t++)!function(e){var e=s[e],t=document.createElement("label");t.classList.add("members__list__item"),t.textContent=e,t.tabIndex=r,r++;var n=document.createElement("input");n.type="radio",n.name="members",n.classList.add("members__list__item__button"),n.value=e,t.onkeydown=function(e){isEnterKey(e)&&(triggerClick(t.childNodes.item(0)),$memberSubmit.disabled=null==selectedMember,triggerClick($memberSubmit))},n.onclick=function(){var e=n.parentNode;n.checked&&(e.classList.contains("members__list__item--selected")?triggerClick($memberSubmit):(elements(".members__list__item",function(e){return e.classList.remove("members__list__item--selected")}),e.classList.add("members__list__item--selected"),selectedMember=n.value)),$memberSubmit.disabled=null==selectedMember},t.appendChild(n),$membersList.appendChild(t)}(t)}clearHash();var TIMEOUT_DELAY=6e4,timeoutHandle=-1;function clearScreen(){resetPage(),loadMembers()}function resetTimeout(){clearTimeout(timeoutHandle),timeoutHandle=setTimeout(clearScreen,TIMEOUT_DELAY)}function saveAttendance(n,e){showLoader();function s(e){return showToast("Failed to mark attendance: "+e,null,!0)}post("/attendance",{name:n,member:e},function(e,t){null!=e?s(e):t.hasOwnProperty("status")?"success"===t.status?(showToast('Successfully marked attendance for "'+n+'"',function(){removeAttendance(n,function(){showToast('Reverted attendance for "'+n+'"')})}),resetPage()):t.hasOwnProperty("reason")?showToast(t.reason,null,!0):s("Unknown Reason"):s("Malformed server data"),hideLoader()})}function removeAttendance(n,s){showLoader();function r(e){return showToast("Failed to change attendance: "+e,null,!0)}del("/attendance",{name:n},function(e,t){null!=e?r(e):t.hasOwnProperty("status")?"success"===t.status?(showToast('Successfully removed attendance for "'+n+'"',null),s()):r("Unknown Reason"):r("Malformed server data"),hideLoader()})}"/attending"!==document.location.pathname&&(loadMembers(),resetTimeout()),nonNull($memberSubmit,function(e){e.onclick=function(){null!=selectedMember&&saveAttendance(selectedMember,!0)}}),nonNull($memberName,function(t){t.onkeyup=function(e){!isEnterKey(e)||0<(e=getRelevantMembers(e=null==(e=t.value)||0===e.length?null:e)).length&&(selectedMember=e[0],$memberSubmit.disabled=null==selectedMember,triggerClick($memberSubmit)),resetTimeout(),fillMembersList(t.value)}}),nonNull($guestName,function(t){t.onkeyup=function(e){isEnterKey(e)&&triggerClick($guestSubmit),resetTimeout(),$guestSubmit.disabled=t.value.length<1}}),nonNull($guestSubmit,function(e){e.onclick=function(){var e=$guestName.value;null!=e&&0<e.length&&saveAttendance(e,!1)}}),elements(".attendance__list__item__buttons__button",function(t){return t.onclick=function(){var e=t.getAttribute("data-name");null!=e&&confirm('Are you sure you want to remove the attendance for "'+e+'"')&&removeAttendance(e,function(){var e=t.parentElement.parentElement;e.parentElement.removeChild(e)})}});